<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Novo paciente ‚Ä¢ RAE Cl√≠nica Digital</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; max-width: 720px; }
    label { display:block; margin-top: 12px; font-weight: bold; }
    input { width: 100%; padding: 10px; margin-top: 6px; }
    .row { display:flex; gap: 12px; }
    .row > div { flex: 1; }
    button { margin-top: 16px; padding: 10px 12px; cursor:pointer; }
    .muted { color:#666; font-size: 13px; }
    #danger { background:#ffebee; border:1px solid #ef5350; color:#c62828; padding:10px; border-radius:8px; margin-top:12px; display:none; }

    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .form-grid .full{
      grid-column: 1 / -1;
    }

    @media (max-width: 720px){
      .form-grid{
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <a href="/pacientes.html">‚Üê Voltar</a>
  <h1 id="title">Paciente</h1>

  <div id="error"></div>

  <div class="card">
    <div class="muted">Cadastro do paciente</div>

    <div class="form-grid">
      <!-- Identifica√ß√£o -->
      <div>
        <label for="nome">Nome</label>
        <input id="nome" placeholder="Nome completo" />
      </div>

      <div>
        <label for="cpf">CPF</label>
        <input id="cpf" placeholder="Somente n√∫meros" />
      </div>

      <div>
        <label for="nascimento">Nascimento</label>
        <input id="nascimento" placeholder="dd/mm/aaaa" />
      </div>

      <div>
        <label for="telefone">Telefone</label>
        <input id="telefone" placeholder="DDD + n√∫mero" />
      </div>

      <div class="full">
        <label for="email">E-mail</label>
        <input id="email" placeholder="email@exemplo.com" />
      </div>

      <!-- Alto custo -->
      <div>
        <label for="cns">CNS</label>
        <input id="cns" placeholder="Cart√£o Nacional de Sa√∫de" />
      </div>

      <div>
        <label for="nomeMae">Nome da m√£e</label>
        <input id="nomeMae" placeholder="Nome completo" />
      </div>

      <!-- Endere√ßo -->
      <div>
        <label for="cep">CEP</label>
        <input id="cep" placeholder="00000-000" />
        <div class="muted">Ao digitar o CEP, tentaremos preencher rua/bairro/cidade/UF.</div>
      </div>

      <div>
        <label for="uf">Estado (UF)</label>
        <input id="uf" maxlength="2" placeholder="SP" />
      </div>

      <div class="full">
        <label for="rua">Rua / Logradouro</label>
        <input id="rua" placeholder="Rua, avenida..." />
      </div>

      <div>
        <label for="numero">N√∫mero</label>
        <input id="numero" placeholder="N¬∫" />
      </div>

      <div>
        <label for="complemento">Complemento</label>
        <input id="complemento" placeholder="Apto, bloco..." />
      </div>

      <div>
        <label for="bairro">Bairro</label>
        <input id="bairro" />
      </div>

      <div>
        <label for="cidade">Cidade</label>
        <input id="cidade" />
      </div>

      <!-- Emerg√™ncia -->
      <div class="full">
        <div class="muted" style="margin-top:10px; font-weight:600;">Contato de emerg√™ncia</div>
      </div>

      <div>
        <label for="emergNome">Nome</label>
        <input id="emergNome" />
      </div>

      <div>
        <label for="emergTelefone">Telefone</label>
        <input id="emergTelefone" />
      </div>

      <div class="full">
        <label for="emergRelacao">Rela√ß√£o (opcional)</label>
        <input id="emergRelacao" placeholder="Ex: irm√£, c√¥njuge, pai..." />
      </div>

      <!-- Observa√ß√µes -->
      <div class="full">
        <label for="obs">Observa√ß√µes cl√≠nicas fixas (opcional)</label>
        <textarea id="obs" style="min-height:120px;" placeholder="Ex: alergias relevantes, alertas importantes..."></textarea>
      </div>
    </div>

    <div class="actions">
      <button id="saveBtn" type="button">üíæ Salvar</button>
      <button id="cancelBtn" type="button">Cancelar</button>
    </div>
  </div>
</form>

  <script>
    const KEY = "rae_patients_v1";

    function loadPatients() {
      const raw = localStorage.getItem(KEY);
      if (!raw) return [];
      try { return JSON.parse(raw) || []; } catch { return []; }
    }

    function savePatients(patients) {
      localStorage.setItem(KEY, JSON.stringify(patients));
    }

    function getId() {
      return new URLSearchParams(location.search).get("id");
    }

    function uid() {
      return "p_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function showError(msg) {
      const d = document.getElementById("danger");
      d.style.display = "block";
      d.textContent = msg;
    }

    function clearError() {
      const d = document.getElementById("danger");
      d.style.display = "none";
      d.textContent = "";
    }

    const id = getId();
    const patients = loadPatients();
    const existing = id ? patients.find(p => p.id === id) : null;

    if (existing) {
      document.getElementById("title").textContent = "Editar paciente";
      document.getElementById("nome").value = existing.nome || "";
      document.getElementById("cpf").value = existing.cpf || "";
      document.getElementById("nascimento").value = existing.nascimento || "";
      document.getElementById("telefone").value = existing.telefone || "";
      document.getElementById("email").value = existing.email || "";
      document.getElementById("endereco").value = existing.endereco || "";
    }

    document.getElementById("form").addEventListener("submit", (e) => {
      e.preventDefault();
      clearError();

      const nome = document.getElementById("nome").value.trim();
      if (!nome) return showError("Nome √© obrigat√≥rio.");

      const cpf = document.getElementById("cpf").value.trim();
      const cpfDigits = cpf.replace(/\D/g, "");
      if (cpfDigits && cpfDigits.length !== 11) return showError("CPF precisa ter 11 d√≠gitos (ou ficar vazio).");

      const p = {
        id: existing?.id || uid(),
        nome,
        cpf: cpfDigits || "",
        nascimento: document.getElementById("nascimento").value.trim(),
        telefone: document.getElementById("telefone").value.trim(),
        email: document.getElementById("email").value.trim(),
        endereco: document.getElementById("endereco").value.trim(),
        updatedAt: new Date().toISOString()
      };

      const next = patients.filter(x => x.id !== p.id);
      next.push(p);
      savePatients(next);

      window.location.href = "/pacientes.html";
    });

    function onlyDigits(s) {
      return (s || "").replace(/\D/g, "");
    }

    function setValue(id, value) {
      const el = document.getElementById(id);
      if (el && (el.value || "") === "") el.value = value || "";
    }

    // debounce simples para n√£o chamar toda hora
    let cepTimer = null;

    async function buscarCepEPreencher(cepDigits) {
      try {
        const resp = await fetch(`https://viacep.com.br/ws/${cepDigits}/json/`);
        if (!resp.ok) return;

        const data = await resp.json();
        if (data.erro) return;

        // S√≥ preenche se os campos estiverem vazios (n√£o sobrescreve o que voc√™ j√° digitou)
        setValue("rua", data.logradouro);
        setValue("bairro", data.bairro);
        setValue("cidade", data.localidade);
        setValue("uf", data.uf);
      } catch {
        // silencioso: se falhar, voc√™ preenche manualmente
      }
    }

    document.getElementById("cep")?.addEventListener("input", (e) => {
      const el = e.target;
      const digits = onlyDigits(el.value);

      // opcional: formatar como 00000-000 sem atrapalhar
      if (digits.length <= 8) {
        el.value = digits.length > 5 ? `${digits.slice(0,5)}-${digits.slice(5)}` : digits;
      }

      clearTimeout(cepTimer);

      if (digits.length === 8) {
        cepTimer = setTimeout(() => buscarCepEPreencher(digits), 250);
      }
    });
  </script>
</body>
</html>
