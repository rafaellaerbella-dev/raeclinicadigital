<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Novo paciente ‚Ä¢ RAE Cl√≠nica Digital</title>
  
  <style>
    * { box-sizing: border-box; }

    body{
      font-family: Arial, sans-serif;
      margin: 24px;
      max-width: 980px;
    }

    a{ color:#0b66c3; text-decoration:none; }

    h1{ margin: 0 0 10px 0; }

    .card{
      border:1px solid #eee;
      padding:16px;
      border-radius:12px;
      margin-top:16px;
      background:#fff;
    }

    .muted{ color:#666; font-size:13px; }

    #error{
      display:none;
      background:#ffebee;
      border:1px solid #ef5350;
      color:#c62828;
      padding:12px;
      border-radius:12px;
      margin-top:12px;
      white-space:pre-wrap;
    }

    label{
      font-weight:600;
      font-size:13px;
      color:#222;
    }

    input, textarea{
      width:100%;
      padding:10px;
      border:1px solid #ddd;
      border-radius:10px;
      font-family:inherit;
      font-size:14px;
      background:#fff;
    }

    textarea{
      min-height:120px;
      resize:vertical;
    }

    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 12px;
    }

    .form-grid > div{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }

    .full{
      grid-column: 1 / -1;
    }

    .section-title{
      grid-column: 1 / -1;
      margin-top: 8px;
      padding-top: 10px;
      border-top: 1px solid #f0f0f0;
      font-weight:700;
      color:#333;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:16px;
    }

    button{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
    }

    button:hover{
      background:#f7f7f7;
    }

    @media (max-width: 720px){
      body{ margin: 16px; }
      .form-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <a href="/pacientes.html">‚Üê Voltar</a>
  <h1 id="title">Paciente</h1>

  <div id="error"></div>

  <div class="card">
    <div class="muted">Cadastro do paciente</div>

    <div class="form-grid">
      <!-- Identifica√ß√£o -->
      <div>
        <label for="nome">Nome</label>
        <input id="nome" placeholder="Nome completo" />
      </div>

      <div>
        <label for="cpf">CPF</label>
        <input id="cpf" placeholder="Somente n√∫meros" />
      </div>

      <div>
        <label for="nascimento">Nascimento</label>
        <input id="nascimento" placeholder="dd/mm/aaaa" />
      </div>

      <div>
        <label for="telefone">Telefone</label>
        <input id="telefone" placeholder="DDD + n√∫mero" />
      </div>

      <div class="full">
        <label for="email">E-mail</label>
        <input id="email" placeholder="email@exemplo.com" />
      </div>

      <!-- Alto custo -->
      <div>
        <label for="cns">CNS</label>
        <input id="cns" placeholder="Cart√£o Nacional de Sa√∫de" />
      </div>

      <div>
        <label for="nomeMae">Nome da m√£e</label>
        <input id="nomeMae" placeholder="Nome completo" />
      </div>

      <!-- Endere√ßo -->
      <div>
        <label for="cep">CEP</label>
        <input id="cep" placeholder="00000-000" />
        <div class="muted">Ao digitar o CEP, tentaremos preencher rua/bairro/cidade/UF.</div>
      </div>

      <div class="full">
        <label for="rua">Rua / Logradouro</label>
        <input id="rua" placeholder="Rua, avenida..." />
      </div>

      <div>
        <label for="numero">N√∫mero</label>
        <input id="numero" placeholder="N¬∫" />
      </div>

      <div>
        <label for="complemento">Complemento</label>
        <input id="complemento" placeholder="Apto, bloco..." />
      </div>

      <div>
        <label for="bairro">Bairro</label>
        <input id="bairro" />
      </div>

      <div>
        <label for="cidade">Cidade</label>
        <input id="cidade" />
      </div>

      <div>
        <label for="uf">Estado (UF)</label>
        <input id="uf" maxlength="2" placeholder="SP" />
      </div>

      <!-- Emerg√™ncia -->
      <div class="full">
        <div class="muted" style="margin-top:10px; font-weight:600;">Contato de emerg√™ncia</div>
      </div>

      <div>
        <label for="emergNome">Nome</label>
        <input id="emergNome" />
      </div>

      <div>
        <label for="emergTelefone">Telefone</label>
        <input id="emergTelefone" />
      </div>

      <div class="full">
        <label for="emergRelacao">Rela√ß√£o (opcional)</label>
        <input id="emergRelacao" placeholder="Ex: irm√£, c√¥njuge, pai..." />
      </div>

      <!-- Observa√ß√µes -->
      <div class="full">
        <label for="obs">Observa√ß√µes cl√≠nicas fixas (opcional)</label>
        <textarea id="obs" style="min-height:120px;" placeholder="Ex: alergias relevantes, alertas importantes..."></textarea>
      </div>
    </div>

    <div class="actions">
      <button id="saveBtn" type="button">üíæ Salvar</button>
      <button id="cancelBtn" type="button">Cancelar</button>
    </div>
  </div>

  <script>
    // ===== Config =====
    const KEY = "rae_patients_v1";
    const qs = (k) => new URLSearchParams(location.search).get(k);

    // ===== Helpers =====
    function onlyDigits(s) {
      return (s || "").replace(/\D/g, "");
    }

    function showError(msg) {
      const e = document.getElementById("error");
      if (!e) return;
      e.style.display = "block";
      e.textContent = msg;
    }

    function clearError() {
      const e = document.getElementById("error");
      if (!e) return;
      e.style.display = "none";
      e.textContent = "";
    }

    function loadPatients() {
      try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
      catch { return []; }
    }

    function savePatients(list) {
      localStorage.setItem(KEY, JSON.stringify(list));
    }

    function uid() {
      return "p_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function setVal(id, v) {
      const el = document.getElementById(id);
      if (el) el.value = v ?? "";
    }

    function getVal(id) {
      const el = document.getElementById(id);
      return (el?.value || "").trim();
    }

    function setIfEmpty(id, v) {
      const el = document.getElementById(id);
      if (!el) return;
      if ((el.value || "").trim() === "") el.value = v || "";
    }

    // ===== ViaCEP =====
    let cepTimer = null;

    async function preencherPorCEP(cepDigits) {
      try {
        const resp = await fetch(`https://viacep.com.br/ws/${cepDigits}/json/`);
        if (!resp.ok) return;

        const data = await resp.json();
        if (data.erro) return;

        setIfEmpty("rua", data.logradouro);
        setIfEmpty("bairro", data.bairro);
        setIfEmpty("cidade", data.localidade);
        setIfEmpty("uf", data.uf);
      } catch {
        // silencioso
      }
    }

    function attachCepListener() {
      const cepEl = document.getElementById("cep");
      if (!cepEl) return;

      cepEl.addEventListener("input", () => {
        const digits = onlyDigits(cepEl.value);

        // formata 00000-000
        cepEl.value = digits.length > 5
          ? `${digits.slice(0, 5)}-${digits.slice(5, 8)}`
          : digits;

        clearTimeout(cepTimer);
        if (digits.length === 8) {
          cepTimer = setTimeout(() => preencherPorCEP(digits), 250);
        }
      });
    }

    // ===== Carregar paciente para edi√ß√£o =====
    const patients = loadPatients();
    const id = qs("id");
    const editing = id ? patients.find(p => p.id === id) : null;

    const titleEl = document.getElementById("title");
    if (titleEl) titleEl.textContent = editing ? "Editar paciente" : "Novo paciente";

    if (editing) {
      clearError();

      setVal("nome", editing.nome || "");
      setVal("cpf", editing.cpf || "");
      setVal("nascimento", editing.nascimento || "");
      setVal("telefone", editing.telefone || "");
      setVal("email", editing.email || "");

      setVal("cns", editing.cns || "");
      setVal("nomeMae", editing.nomeMae || "");

      const addr = editing.endereco_obj || {};
      setVal("cep", addr.cep ? (addr.cep.length === 8 ? `${addr.cep.slice(0,5)}-${addr.cep.slice(5)}` : addr.cep) : "");
      setVal("rua", addr.rua || "");
      setVal("numero", addr.numero || "");
      setVal("complemento", addr.complemento || "");
      setVal("bairro", addr.bairro || "");
      setVal("cidade", addr.cidade || "");
      setVal("uf", (addr.uf || "").toUpperCase());

      const em = editing.emergencia || {};
      setVal("emergNome", em.nome || "");
      setVal("emergTelefone", em.telefone || "");
      setVal("emergRelacao", em.relacao || "");

      setVal("obs", editing.obs || "");
    }

    // ativa CEP
    attachCepListener();

    // ===== Salvar =====
    document.getElementById("saveBtn")?.addEventListener("click", () => {
      clearError();

      const nome = getVal("nome");
      if (!nome) {
        showError("Nome √© obrigat√≥rio.");
        return;
      }

      const obj = {
        id: editing?.id || uid(),
        nome,
        cpf: onlyDigits(getVal("cpf")),
        nascimento: getVal("nascimento"),
        telefone: onlyDigits(getVal("telefone")),
        email: getVal("email"),

        cns: onlyDigits(getVal("cns")),
        nomeMae: getVal("nomeMae"),

        endereco_obj: {
          cep: onlyDigits(getVal("cep")),
          rua: getVal("rua"),
          numero: getVal("numero"),
          complemento: getVal("complemento"),
          bairro: getVal("bairro"),
          cidade: getVal("cidade"),
          uf: getVal("uf").toUpperCase()
        },

        emergencia: {
          nome: getVal("emergNome"),
          telefone: onlyDigits(getVal("emergTelefone")),
          relacao: getVal("emergRelacao")
        },

        obs: getVal("obs"),
        updatedAt: new Date().toISOString()
      };

      // upsert
      const idx = patients.findIndex(p => p.id === obj.id);
      if (idx >= 0) patients[idx] = obj;
      else patients.push(obj);

      savePatients(patients);

      // volta para a ficha
      window.location.href = `/paciente.html?id=${encodeURIComponent(obj.id)}`;
    });

    // ===== Cancelar =====
    document.getElementById("cancelBtn")?.addEventListener("click", () => {
      if (editing) {
        window.location.href = `/paciente.html?id=${encodeURIComponent(editing.id)}`;
      } else {
        window.location.href = "/pacientes.html";
      }
    });
  </script>
</body>
</html>
