<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Evolu√ß√£o ‚Ä¢ RAE Cl√≠nica Digital</title>

  <style>
    * { box-sizing: border-box; }
    body { overflow-x: hidden; }

    body {
      font-family: Arial, sans-serif;
      margin: 24px;
      max-width: 900px;
    }

    a { color:#0b66c3; text-decoration:none; }

    .card {
      border:1px solid #eee;
      padding:16px;
      border-radius:10px;
      margin-top: 16px;
      overflow: hidden;
    }

    label {
      display:block;
      margin-top: 14px;
      font-weight: 600;
    }

    input, textarea {
      width: 100%;
      max-width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
    }

    textarea { min-height: 260px; resize: vertical; }

    .row { display:flex; gap: 12px; flex-wrap: wrap; }

    button {
      margin-top: 16px;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
    }

    .muted { color:#666; font-size: 13px; margin-top: 6px; }

    #app { display:none; }

    #error {
      display:none;
      background:#ffebee;
      border:1px solid #ef5350;
      color:#c62828;
      padding:12px;
      border-radius:10px;
      white-space: pre-wrap;
      margin-top: 12px;
    }
  </style>

  <script>
    // üîí Login check (robusto)
    (async () => {
      try {
        const r = await fetch("https://api.raeclinicadigital.com/auth/me", { credentials: "include" });
        const j = await r.json().catch(() => ({}));
        if (!j.ok) { window.location.href = "/auth/login.html"; return; }

        const showApp = () => {
          const el = document.getElementById("app");
          if (el) el.style.display = "block";
        };

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", showApp);
        } else {
          showApp();
        }
      } catch {
        window.location.href = "/auth/login.html";
      }
    })();
  </script>
</head>

<body>
  <div id="app" style="display:none;">
    <a id="backLink">‚Üê Voltar para o paciente</a>

    <h1 id="title">Evolu√ß√£o</h1>

    <!-- ===== VIEW MODE ===== -->
    <div id="viewMode" style="display:none;">
      <div id="viewDate" class="muted"></div>
      <div id="viewStatus" class="muted" style="display:none;"></div>
      <div id="viewInactiveReason" class="muted" style="display:none; margin-top:8px;"></div>
      <div id="viewRegistered" class="muted" style="margin-top:6px;"></div>

      <div id="viewConsultTitle" style="margin-top:14px; font-weight:600;"></div>

      <div class="card" style="margin-top:12px;">
        <div id="viewText" style="white-space:pre-wrap;"></div>
      </div>

      <!-- a√ß√µes/anota√ß√µes: s√≥ assinada ativa -->
      <div class="row" id="annotationActions" style="margin-top:16px; display:none;">
        <button id="addAnnotationBtn" type="button">üìù Anotar</button>
      </div>

      <div id="annotationBlock" style="display:none; margin-top:12px;">
        <label for="annotationText">Anota√ß√£o</label>
        <textarea id="annotationText" placeholder="Adicionar anota√ß√£o complementar..." style="min-height:120px;"></textarea>
        <div class="row">
          <button id="saveAnnotationBtn" type="button">‚ûï Salvar anota√ß√£o</button>
        </div>
      </div>

      <div id="annotationsList" style="margin-top:16px; display:none;">
        <div class="muted" style="font-weight:600;">Anota√ß√µes</div>
        <div id="annotationsItems" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- ===== EDIT MODE ===== -->
    <div class="card" id="editCard">
      <label for="dataEvolucao">Data da evolu√ß√£o (dd/mm/aaaa)</label>
      <input id="dataEvolucao" placeholder="29/01/2026" />

      <label for="titulo">Tipo/T√≠tulo (opcional)</label>
      <input id="titulo" placeholder="Ex: Consulta de seguimento" />

      <label for="texto">Evolu√ß√£o</label>
      <textarea id="texto" placeholder="Digite a evolu√ß√£o cl√≠nica..."></textarea>

      <div class="muted" id="info"></div>

      <div class="row">
        <button id="saveBtn" type="button">üíæ Salvar evolu√ß√£o</button>
        <button id="signBtn" type="button">‚úçÔ∏è Assinar</button>
      </div>

      <div class="muted" id="signedInfo" style="margin-top:10px;"></div>
    </div>

    <div id="error"></div>
  </div>

  <script>
    /* ========= helpers ========= */
    const EVOL_KEY = "rae_evolucoes_v1";
    const qs = (k) => new URLSearchParams(location.search).get(k);

    function loadMap() {
      try { return JSON.parse(localStorage.getItem(EVOL_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveMap(map) {
      localStorage.setItem(EVOL_KEY, JSON.stringify(map));
    }
    function isoToBRDate(iso) {
      try { return new Date(iso).toLocaleDateString("pt-BR"); } catch { return ""; }
    }
    function showError(msg) {
      const e = document.getElementById("error");
      e.style.display = "block";
      e.textContent = msg;
    }
    function ensureAnnotations(ev) {
      if (!Array.isArray(ev.annotations)) ev.annotations = [];
    }

    /* ========= params ========= */
    const pacienteId = qs("pacienteId");
    const evolucaoId = qs("id");
    const isViewMode = qs("mode") === "view";

    if (!pacienteId) {
      showError("Falta ?pacienteId= na URL.");
      throw new Error("pacienteId ausente");
    }

    /* ========= elements ========= */
    const backLink = document.getElementById("backLink");
    const titleEl = document.getElementById("title");

    const viewModeEl = document.getElementById("viewMode");
    const viewDateEl = document.getElementById("viewDate");
    const viewStatusEl = document.getElementById("viewStatus");
    const viewInactiveReasonEl = document.getElementById("viewInactiveReason");
    const viewRegisteredEl = document.getElementById("viewRegistered");
    const viewConsultTitleEl = document.getElementById("viewConsultTitle");
    const viewTextEl = document.getElementById("viewText");

    const annotationActions = document.getElementById("annotationActions");
    const addAnnotationBtn = document.getElementById("addAnnotationBtn");
    const annotationBlock = document.getElementById("annotationBlock");
    const annotationTextEl = document.getElementById("annotationText");
    const saveAnnotationBtn = document.getElementById("saveAnnotationBtn");

    const annotationsList = document.getElementById("annotationsList");
    const annotationsItems = document.getElementById("annotationsItems");

    const editCardEl = document.getElementById("editCard");
    const dataEl = document.getElementById("dataEvolucao");
    const tituloEl = document.getElementById("titulo");
    const textoEl = document.getElementById("texto");
    const infoEl = document.getElementById("info");
    const signedInfoEl = document.getElementById("signedInfo");
    const saveBtn = document.getElementById("saveBtn");
    const signBtn = document.getElementById("signBtn");

    backLink.href = `/paciente.html?id=${encodeURIComponent(pacienteId)}`;

    /* ========= load ========= */
    const map = loadMap();
    const list = (map[pacienteId] || []).slice();
    let current = null;

    if (evolucaoId) {
      current = list.find(e => e.id === evolucaoId) || null;
      if (!current) showError("Evolu√ß√£o n√£o encontrada.");
    }
    if (current) ensureAnnotations(current);

    function showEdit() {
      viewModeEl.style.display = "none";
      editCardEl.style.display = "block";
      annotationActions.style.display = "none";
      annotationBlock.style.display = "none";
      annotationTextEl.value = "";
      annotationsList.style.display = "none";
      annotationsItems.innerHTML = "";
    }

    function renderAnnotations(ev) {
      const canShow = !!ev.signedAt && !ev.inactiveAt;
      if (!canShow) {
        annotationsList.style.display = "none";
        annotationsItems.innerHTML = "";
        return;
      }

      ensureAnnotations(ev);
      if (!ev.annotations.length) {
        annotationsList.style.display = "none";
        annotationsItems.innerHTML = "";
        return;
      }

      annotationsList.style.display = "block";
      annotationsItems.innerHTML = "";

      ev.annotations.forEach(a => {
        const div = document.createElement("div");
        div.className = "card";
        div.style.marginTop = "10px";
        div.style.padding = "12px";

        const when = new Date(a.createdAt).toLocaleString("pt-BR");
        div.innerHTML = `
          <div class="muted" style="margin-bottom:8px;">${when}</div>
          <div style="white-space:pre-wrap;"></div>
        `;
        div.querySelector("div[style*='white-space']").textContent = a.text;
        annotationsItems.appendChild(div);
      });
    }

    function showView(ev) {
      editCardEl.style.display = "none";
      viewModeEl.style.display = "block";

      const regDate = ev.registeredAt ? isoToBRDate(ev.registeredAt) : "";
      const consultDate = ev.evolutionDate || regDate;

      viewDateEl.textContent = consultDate || "";

      // INATIVA abaixo da data
      if (ev.inactiveAt) {
        viewStatusEl.textContent = "INATIVA";
        viewStatusEl.style.color = "#c62828";
        viewStatusEl.style.fontWeight = "600";
        viewStatusEl.style.textTransform = "uppercase";
        viewStatusEl.style.fontSize = "12px";
        viewStatusEl.style.marginTop = "10px";
        viewStatusEl.style.display = "block";
      } else {
        viewStatusEl.style.display = "none";
      }

      // Motivo (se inativa)
      if (ev.inactiveAt) {
        const when = isoToBRDate(ev.inactiveAt);
        const reason = (ev.inactiveReason || "").trim();
        viewInactiveReasonEl.style.display = "block";
        viewInactiveReasonEl.textContent =
          reason ? `Motivo: ${reason}${when ? " ‚Ä¢ " + when : ""}` : `Inativada${when ? " em " + when : ""}`;
      } else {
        viewInactiveReasonEl.style.display = "none";
        viewInactiveReasonEl.textContent = "";
      }

      // Registrado em s√≥ se diferente
      viewRegisteredEl.textContent =
        ev.evolutionDate && regDate && ev.evolutionDate !== regDate
          ? `Registrado em: ${regDate}`
          : "";

      viewConsultTitleEl.textContent = ev.titulo || "";
      viewTextEl.textContent = ev.texto || "";

      // Anotar: s√≥ assinada e ativa
      const canAnnotate = !!ev.signedAt && !ev.inactiveAt;
      annotationActions.style.display = canAnnotate ? "flex" : "none";
      annotationBlock.style.display = "none";
      annotationTextEl.value = "";

      renderAnnotations(ev);
    }

    /* ========= initial render ========= */
    const now = new Date().toISOString();

    if (current) {
      const isSigned = !!current.signedAt;
      const isInactive = !!current.inactiveAt;

      infoEl.textContent = current.registeredAt
        ? `Registrado em: ${new Date(current.registeredAt).toLocaleString("pt-BR")}`
        : `Registrado em: ${new Date().toLocaleString("pt-BR")}`;

      signedInfoEl.textContent = isSigned
        ? `Assinada em: ${new Date(current.signedAt).toLocaleString("pt-BR")}` + (isInactive ? " ‚Ä¢ INATIVA" : "")
        : "";

      if (isViewMode || isSigned) {
        titleEl.textContent = "Evolu√ß√£o";
        showView(current);
        saveBtn.style.display = "none";
        signBtn.style.display = "none";
      } else {
        titleEl.textContent = "Editar evolu√ß√£o";
        showEdit();
        dataEl.value = current.evolutionDate || "";
        tituloEl.value = current.titulo || "";
        textoEl.value = current.texto || "";
        saveBtn.style.display = "inline-block";
        signBtn.style.display = "inline-block";
      }
    } else {
      titleEl.textContent = "Nova evolu√ß√£o";
      showEdit();
      infoEl.textContent = `Registrado em: ${new Date().toLocaleString("pt-BR")}`;
      signedInfoEl.textContent = "";
      saveBtn.style.display = "inline-block";
      signBtn.style.display = "inline-block";
    }

    /* ========= save (draft) ========= */
    saveBtn.addEventListener("click", () => {
      const texto = textoEl.value.trim();
      if (!texto) { alert("Informe o texto da evolu√ß√£o."); return; }

      const evolutionDate = dataEl.value.trim() || null;

      if (current) {
        current.titulo = tituloEl.value.trim();
        current.texto = texto;
        current.evolutionDate = evolutionDate;
        current.updatedAt = new Date().toISOString();
      } else {
        list.push({
          id: crypto.randomUUID(),
          pacienteId,
          titulo: tituloEl.value.trim(),
          texto,
          evolutionDate,
          registeredAt: now,
          updatedAt: now,
          signedAt: null,
          inactiveAt: null,
          inactiveReason: null,
          annotations: []
        });
      }

      map[pacienteId] = list;
      saveMap(map);
      window.location.href = `/paciente.html?id=${encodeURIComponent(pacienteId)}`;
    });

    /* ========= sign ========= */
    signBtn.addEventListener("click", () => {
      if (!current) {
        alert("Para assinar, salve a evolu√ß√£o primeiro.");
        return;
      }
      if (!confirm("Ao assinar, a evolu√ß√£o n√£o poder√° mais ser editada.\n\nDeseja continuar?")) return;

      current.signedAt = new Date().toISOString();
      current.updatedAt = current.signedAt;
      if (!current.registeredAt) current.registeredAt = current.signedAt;

      map[pacienteId] = list;
      saveMap(map);

      window.location.href = `/evolucao-form.html?pacienteId=${encodeURIComponent(pacienteId)}&id=${encodeURIComponent(current.id)}&mode=view`;
    });

    /* ========= annotate (signed + active) ========= */
    addAnnotationBtn.addEventListener("click", () => {
      annotationBlock.style.display = "block";
      annotationTextEl.focus();
    });

    saveAnnotationBtn.addEventListener("click", () => {
      if (!current) return;

      if (!current.signedAt || current.inactiveAt) {
        alert("N√£o √© poss√≠vel anotar nesta evolu√ß√£o.");
        return;
      }

      const text = annotationTextEl.value.trim();
      if (!text) { alert("Digite a anota√ß√£o."); return; }

      ensureAnnotations(current);

      current.annotations.push({
        id: crypto.randomUUID(),
        text,
        createdAt: new Date().toISOString()
      });

      const idx = list.findIndex(e => e.id === current.id);
      if (idx >= 0) list[idx] = current;

      map[pacienteId] = list;
      saveMap(map);

      renderAnnotations(current);

      annotationTextEl.value = "";
      annotationBlock.style.display = "none";
      alert("Anota√ß√£o adicionada.");
    });
  </script>
</body>
</html>