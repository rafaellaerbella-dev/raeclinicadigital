<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Evolu√ß√£o ‚Ä¢ RAE Cl√≠nica Digital</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 24px;
      max-width: 900px;
    }

    a { color:#0b66c3; text-decoration:none; }

    .card {
      border:1px solid #eee;
      padding:16px;
      border-radius:10px;
      margin-top: 16px;
    }

    label {
      display:block;
      margin-top: 14px;
      font-weight: 600;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
    }

      textarea {
        min-height: 260px;
        resize: vertical;
        box-sizing: border-box;
      }

    .row {
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      margin-top: 16px;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
    }

    .muted {
      color:#666;
      font-size: 13px;
      margin-top: 6px;
    }

    #app { display:none; }

    #error {
      display:none;
      background:#ffebee;
      border:1px solid #ef5350;
      color:#c62828;
      padding:12px;
      border-radius:10px;
      white-space: pre-wrap;
      margin-top: 12px;
    }
  </style>

  <script>
    // üîí Verifica√ß√£o de login (RAE)
    (async () => {
      try {
        const r = await fetch(
          "https://api.raeclinicadigital.com/auth/me",
          { credentials: "include" }
        );
        const j = await r.json().catch(() => ({}));
        if (!j.ok) {
          window.location.href = "/auth/login.html";
          return;
        }
        document.getElementById("app").style.display = "block";
      } catch {
        window.location.href = "/auth/login.html";
      }
    })();
  </script>
</head>

<body>
  <div id="app">
    <a id="backLink">‚Üê Voltar para o paciente</a>

    <h1>Evolu√ß√£o</h1>

    <div class="card">
      <label for="dataEvolucao">Data da evolu√ß√£o (dd/mm/aaaa)</label>
      <input id="dataEvolucao" placeholder="29/01/2026" />
    
      <label for="titulo">T√≠tulo (opcional)</label>
      <input id="titulo" placeholder="Ex: Consulta de seguimento" />
    
      <label for="texto">Evolu√ß√£o</label>
      <textarea id="texto" placeholder="Digite a evolu√ß√£o cl√≠nica..."></textarea>
    
      <div class="muted" id="info"></div>
    
      <div class="row">
        <button id="saveBtn" type="button">üíæ Salvar evolu√ß√£o</button>
      </div>
    </div>

    <div id="error"></div>
  </div>

  <script>
    const KEY = "RAE_EVOLUCOES_V1";
  
    const params = new URLSearchParams(location.search);
    const pacienteId = params.get("pacienteId");
    const evolucaoId = params.get("id"); // se existir, √© edi√ß√£o
  
    document.getElementById("backLink").href =
      `/paciente.html?id=${encodeURIComponent(pacienteId || "")}`;
  
    function showError(msg) {
      const e = document.getElementById("error");
      e.textContent = msg;
      e.style.display = "block";
    }
  
    function loadAll() {
      try { return JSON.parse(localStorage.getItem(KEY)) || []; }
      catch { return []; }
    }
  
    function saveAll(list) {
      localStorage.setItem(KEY, JSON.stringify(list));
    }
  
    function todayBR() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
    }
  
    const evolucoes = loadAll();
  
    if (!pacienteId) {
      showError("pacienteId n√£o informado na URL.");
    }
  
    // Localiza evolu√ß√£o para edi√ß√£o
    let current = null;
    if (evolucaoId) {
      current = evolucoes.find(e => e.id === evolucaoId);
      if (!current) showError("Evolu√ß√£o n√£o encontrada.");
    }
  
    // Preenche form
    const dataEvolucaoEl = document.getElementById("dataEvolucao");
    const tituloEl = document.getElementById("titulo");
    const textoEl = document.getElementById("texto");
    const infoEl = document.getElementById("info");
  
    if (!dataEvolucaoEl || !tituloEl || !textoEl || !infoEl) {
      showError("Campos do formul√°rio n√£o encontrados (verifique ids: dataEvolucao, titulo, texto, info).");
    } else {
      if (current) {
        // Modo edi√ß√£o
        document.getElementById("title").textContent = "Editar evolu√ß√£o";
        dataEvolucaoEl.value = current.dataEvolucao || "";
        tituloEl.value = current.titulo || "";
        textoEl.value = current.texto || "";
        infoEl.textContent = current.registradoEm
          ? ("Registrado em: " + new Date(current.registradoEm).toLocaleString("pt-BR"))
          : "Registrado em: (desconhecido)";
      } else {
        // Modo novo
        document.getElementById("title").textContent = "Nova evolu√ß√£o";
        dataEvolucaoEl.value = todayBR();
        tituloEl.value = "";
        textoEl.value = "";
        infoEl.textContent = "Registrado em: " + new Date().toLocaleString("pt-BR");
      }
    }
  
    // Salvar
    const btn = document.getElementById("saveBtn");
    if (!btn) {
      alert("saveBtn n√£o encontrado (id errado ou HTML n√£o carregou).");
    } else {
      btn.addEventListener("click", () => {
        // ... seu c√≥digo de salvar
      });
    }
    
    document.getElementById("saveBtn").addEventListener("click", () => {
      const dataEvolucao = (dataEvolucaoEl.value || "").trim();
      const titulo = (tituloEl.value || "").trim();
      const texto = (textoEl.value || "").trim();
  
      if (!pacienteId) return;
      if (!dataEvolucao) { alert("Informe a data da evolu√ß√£o (dd/mm/aaaa)."); return; }
      if (!texto) { alert("A evolu√ß√£o n√£o pode ficar vazia."); return; }
  
      if (current) {
        // Atualiza
        current.dataEvolucao = dataEvolucao;
        current.titulo = titulo;
        current.texto = texto;
  
        // Mant√©m registradoEm original (n√£o mexe)
      } else {
        // Cria nova
        evolucoes.push({
          id: crypto.randomUUID(),
          pacienteId,
          dataEvolucao,                 // ‚úÖ edit√°vel
          titulo,
          texto,
          registradoEm: new Date().toISOString() // ‚úÖ autom√°tico
        });
      }
  
      saveAll(evolucoes);
      window.location.href = `/paciente.html?id=${encodeURIComponent(pacienteId)}`;
    });
  </script>
</body>
</html>
