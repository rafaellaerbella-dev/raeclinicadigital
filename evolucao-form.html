<!DOCTYPE html><html lang="pt-BR"><head>  <meta charset="UTF-8" />  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>  <title>Evolu√ß√£o‚Ä¢ RAE Cl√≠nica Digital</title>  <style>    * { box-sizing: border-box; }    body { overflow-x: hidden; }    body{      font-family: Arial, sans-serif;      margin: 24px;      max-width: 900px;    }    a { color:#0b66c3; text-decoration:none; }    .card{      border:1px solid #eee;      padding:16px;      border-radius:10px;      margin-top:16px;      overflow:hidden;    }    label{ display:block; margin-top:14px; font-weight:600; }    input, textarea, select{      width:100%;      max-width:100%;      padding:10px;      margin-top:6px;      border:1px solid #ddd;      border-radius:8px;      font-family:inherit;      font-size:14px;      background:#fff;    }    textarea{ min-height:220px; resize:vertical; }    .row{ display:flex; gap:12px; flex-wrap:wrap; }    button{      padding:10px 14px;      border-radius:8px;      border:1px solid #ddd;      background:#fff;      cursor:pointer;    }    .muted{ color:#666; font-size:13px; margin-top:6px; }    #app{ display:none; }    #error{      display:none;      background:#ffebee;      border:1px solid #ef5350;      color:#c62828;      padding:12px;      border-radius:10px;      white-space:pre-wrap;      margin-top:12px;    }    /* barra de a√ß√µes no view */    .actionbar{      display:flex;      gap:10px;      flex-wrap:wrap;      margin-top:12px;    }    .pill{      display:inline-block;      font-size:12px;      padding:2px 8px;      border-radius:999px;      border:1px solid #ddd;      color:#555;      margin-left:8px;    }    .pill.signed{ color:#2e7d32; border-color:#cfe6d3; }    .pill.inactive{ color:#c62828; border-color:#f3c6c6; }    .segmented{      display:flex;      gap:0;      border:1px solid #ddd;      border-radius:10px;      overflow:hidden;      margin-top:6px;      background:#fff;    }    .seg-btn{      flex:1;      padding:10px 12px;      border:0;      background:#fff;      cursor:pointer;      font-size:14px;    }    .seg-btn + .seg-btn{      border-left:1px solid #ddd;    }    .seg-btn.active{      background:#f2f2f2;      font-weight:600;    }    .picker{      border:1px solid #eee;      border-radius:10px;      margin-top:10px;      overflow:hidden;      background:#fff;    }    .picker-item{      width:100%;      text-align:left;      padding:12px 12px;      border:0;      background:#fff;      cursor:pointer;      font-size:14px;    }    .picker-item + .picker-item{      border-top:1px solid #eee;    }    .picker-item:hover{      background:#f7f7f7;    }  </style>  <script>    // üîí Login check (robusto)    (async () => {      try {        const r = await fetch("https://api.raeclinicadigital.com/auth/me", { credentials: "include" });        const j = await r.json().catch(() => ({}));        if (!j.ok) { window.location.href = "/auth/login.html"; return; }        const showApp = () => {          const el = document.getElementById("app");          if (el) el.style.display = "block";        };        if (document.readyState === "loading") {          document.addEventListener("DOMContentLoaded", showApp);        } else {          showApp();        }      } catch {        window.location.href = "/auth/login.html";      }    })();  </script></head><body>  <div id="app" style="display:none;">    <a id="backLink">‚Üê Voltar para o paciente</a>    <h1 id="title">Evolu√ß√£o</h1>    <!-- ===== VIEW MODE ===== -->    <div id="viewMode" style="display:none;">      <div id="viewDate" class="muted"></div>      <div id="viewType" class="muted" style="margin-top:6px; font-weight:600;"></div>      <div id="viewStatus" class="muted" style="display:none;"></div>      <div id="viewInactiveReason" class="muted" style="display:none; margin-top:8px;"></div>      <div id="viewRegistered" class="muted" style="margin-top:6px;"></div>      <div class="card">        <div id="viewFields" style="display:none;"></div>        <div id="viewText" style="white-space:pre-wrap; display:none;"></div>      </div>      <div class="actionbar" id="viewActions">        <button id="btnEditarView" type="button">Editar</button>        <button id="btnAssinarView" type="button">Assinar</button>        <button id="btnExcluirView" type="button">Excluir</button>      </div>      <!-- anota√ß√µes: s√≥ assinada e ativa -->      <div class="actionbar" id="annotationActions" style="margin-top:16px; display:none;">        <button id="addAnnotationBtn" type="button">üìù Anotar</button>      </div>      <div id="annotationBlock" style="display:none; margin-top:12px;">        <label for="annotationText">Anota√ß√£o</label>        <textarea id="annotationText" placeholder="Adicionar anota√ß√£o complementar..." style="min-height:120px;"></textarea>        <div class="actionbar">          <button id="saveAnnotationBtn" type="button">‚ûï Salvar anota√ß√£o</button>        </div>      </div>      <div id="annotationsList" style="margin-top:16px; display:none;">        <div class="muted" style="font-weight:600;">Anota√ß√µes</div>        <div id="annotationsItems" style="margin-top:10px;"></div>      </div>    </div>    <!-- ===== EDIT MODE ===== -->    <div class="card" id="editCard" style="display:none;">      <label for="dataEvolucao">Data do atendimento (dd/mm/aaaa)</label>      <input id="dataEvolucao" placeholder="30/01/2026" />      <label>Tipo</label>      <div class="segmented" id="tipoSeg">        <button type="button" class="seg-btn" data-type="primeira_consulta">Primeira consulta</button>        <button type="button" class="seg-btn" data-type="evolucao">Evolu√ß√£o</button>        <button type="button" class="seg-btn" data-type="intercorrencia">Intercorr√™ncia</button>      </div>      <!-- mant√©m um input hidden s√≥ para guardar o valor atual (e facilitar o resto do JS) -->      <input type="hidden" id="tipo" value="evolucao" />      <label>Modo do registro</label>        <div class="segmented" id="modoSeg">          <button type="button" class="seg-btn" data-mode="text">Texto livre</button>          <button type="button" class="seg-btn" data-mode="fields">Campos</button>        </div>        <input type="hidden" id="modo" value="text" />      <div id="fieldsWrap" style="display:none; margin-top:10px;"></div>      <div id="optionalControls" style="display:none; margin-top:10px;">        <button id="addSectionBtn" type="button">+ Adicionar se√ß√£o</button>      </div>      <div id="sectionPicker" class="picker" style="display:none;">        <div id="sectionOptions"></div>      </div>      <div id="textWrap">        <label for="texto">Registro cl√≠nico</label>        <textarea id="texto" placeholder="Digite o registro cl√≠nico..."></textarea>      </div>      <div class="muted" id="info"></div>      <div class="actionbar">        <button id="saveBtn" type="button">üíæ Salvar</button>        <button id="signBtn" type="button">‚úçÔ∏è Assinar</button>        <button id="deleteBtn" type="button">üóë Excluir</button>      </div>      <div class="muted" id="signedInfo" style="margin-top:10px;"></div>    </div>    <div id="error"></div>  </div>  <script>    // ========= helpers =========    const STORE_KEY = "rae_evolucoes_v1";    const qs = (k) => new URLSearchParams(location.search).get(k);    const PREF_MODE_KEY = "rae_pref_mode_by_type_v1";    function loadModePrefs() {      try { return JSON.parse(localStorage.getItem(PREF_MODE_KEY) || "{}"); }      catch { return {}; }    }    function saveModePref(type, mode) {      const prefs = loadModePrefs();      prefs[type] = mode;      localStorage.setItem(PREF_MODE_KEY, JSON.stringify(prefs));    }    function defaultModeForType(type) {      const prefs = loadModePrefs();      return prefs[type] || "text";    }    function loadMap() {      try { return JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }      catch { return {}; }    }    function saveMap(map) { localStorage.setItem(STORE_KEY, JSON.stringify(map)); }    function isoToBRDate(iso) {      try { return new Date(iso).toLocaleDateString("pt-BR"); } catch { return ""; }    }    function showError(msg) {      const e = document.getElementById("error");      e.style.display = "block";      e.textContent = msg;    }    function ensureAnnotations(ev) {      if (!Array.isArray(ev.annotations)) ev.annotations = [];    }    function typeLabel(t) {      if (t === "primeira_consulta") return "Primeira consulta";      if (t === "evolucao" || t === "retorno" || t === "evolu√ß√£o") return "Evolu√ß√£o";      if (t === "intercorrencia" || t === "intercorr√™ncia") return "Intercorr√™ncia";      return "Evolu√ß√£o";    }    function ensureFields(ev) {      if (!ev) return;      if (!ev.fields || typeof ev.fields !== "object") ev.fields = {};      if (!ev.mode) ev.mode = "text";      if (!Array.isArray(ev.extraSections)) ev.extraSections = [];    }    // Campos (primeira vers√£o)    const FIELDS_PRIMEIRA = [      "Identifica√ß√£o","Queixa e Dura√ß√£o","HPMA","Medica√ß√µes em uso","Antecedentes Psiqui√°tricos",      "Antecedentes Cl√≠nicos","Alergias","Antecedentes Familiares","Exame Ps√≠quico","Antropometria",      "Exames Complementares","Hip√≥teses Diagn√≥sticas","Conduta"    ];    const FIELDS_EVOLUCAO = [      "Identifica√ß√£o","Medica√ß√µes em uso","Resumo do Caso","Evolu√ß√£o","Exame Ps√≠quico","Antropometria",      "Exames Complementares","Hip√≥teses Diagn√≥sticas","Conduta"    ];    const FIELDS_INTER = ["Identifica√ß√£o","Intercorr√™ncia","Conduta"    ];    const OPTIONAL_SECTIONS = [    "Hist√≥ria de Vida",    "Funcionamento e Personalidade",    "Padr√£o de uso de SPA",    "Escalas"  ];    function fieldsForType(type) {      if (type === "primeira_consulta") return FIELDS_PRIMEIRA;      if (type === "evolucao") return FIELDS_EVOLUCAO;      return FIELDS_INTER;    }    // ========= params =========    const pacienteId = qs("pacienteId");    const itemId = qs("id");    const mode = qs("mode"); // "view" ou "edit"    const isViewMode = (mode === "view");    if (!pacienteId) { showError("Falta ?pacienteId= na URL."); throw new Error("pacienteId ausente"); }    // ========= elements =========    const backLink = document.getElementById("backLink");    const titleEl = document.getElementById("title");    const viewModeEl = document.getElementById("viewMode");    const viewDateEl = document.getElementById("viewDate");    const viewTypeEl = document.getElementById("viewType");    const viewStatusEl = document.getElementById("viewStatus");    const viewInactiveReasonEl = document.getElementById("viewInactiveReason");    const viewRegisteredEl = document.getElementById("viewRegistered");    const viewTextEl = document.getElementById("viewText");    const viewFieldsEl = document.getElementById("viewFields");    const btnEditarView = document.getElementById("btnEditarView");    const btnAssinarView = document.getElementById("btnAssinarView");    const btnExcluirView = document.getElementById("btnExcluirView");    const annotationActions = document.getElementById("annotationActions");    const addAnnotationBtn = document.getElementById("addAnnotationBtn");    const annotationBlock = document.getElementById("annotationBlock");    const annotationTextEl = document.getElementById("annotationText");    const saveAnnotationBtn = document.getElementById("saveAnnotationBtn");    const annotationsList = document.getElementById("annotationsList");    const annotationsItems = document.getElementById("annotationsItems");    const editCardEl = document.getElementById("editCard");    const dataEl = document.getElementById("dataEvolucao");    const tipoSegEl = document.getElementById("tipoSeg");    const tipoEl = document.getElementById("tipo");    const modoEl = document.getElementById("modo");    const modoSegEl = document.getElementById("modoSeg");    function setTipo(type) {      tipoEl.value = type;      const btns = tipoSegEl.querySelectorAll(".seg-btn");      btns.forEach(b => b.classList.toggle("active", b.getAttribute("data-type") === type));      titleEl.textContent = typeLabel(type);      // Se estiver em modo fields, re-renderiza campos      if ((modoEl.value || "text") === "fields") {        applyModeUI(current || {});      }      // Se for NOVO (n√£o tem current), ajustar modo default para esse tipo      if (!current) {        const def = defaultModeForType(type);        // usa setModo pra manter estado e salvar prefer√™ncia corretamente        setModo(def);      }    }    tipoSegEl.addEventListener("click", (e) => {      if (current?.signedAt) {        alert("Registro assinado n√£o pode ter o tipo alterado.");        return;      }      const t = e.target?.getAttribute?.("data-type");      if (!t) return;      setTipo(t);    });    function setModo(mode) {      modoEl.value = mode;      (current || {}).mode = mode;      const btns = modoSegEl.querySelectorAll(".seg-btn");      btns.forEach(b => b.classList.toggle("active", b.getAttribute("data-mode") === mode));      applyModeUI(current || {});      // lembrar prefer√™ncia por tipo      saveModePref(tipoEl.value || "evolucao", mode);    }    modoSegEl.addEventListener("click", (e) => {      if (current?.signedAt) {        alert("Registro assinado n√£o pode ter o modo alterado.");        return;      }      const m = e.target?.getAttribute?.("data-mode");      if (!m) return;      setModo(m);    });    const fieldsWrapEl = document.getElementById("fieldsWrap");    const textWrapEl = document.getElementById("textWrap");    const optionalControlsEl = document.getElementById("optionalControls");    const addSectionBtn = document.getElementById("addSectionBtn");    const sectionPickerEl = document.getElementById("sectionPicker");    const sectionOptionsEl = document.getElementById("sectionOptions");    const closeSectionPickerBtn = document.getElementById("closeSectionPicker");    const textoEl = document.getElementById("texto");    const infoEl = document.getElementById("info");    const signedInfoEl = document.getElementById("signedInfo");    const saveBtn = document.getElementById("saveBtn");    const signBtn = document.getElementById("signBtn");    const deleteBtn = document.getElementById("deleteBtn");    backLink.href = `/paciente.html?id=${encodeURIComponent(pacienteId)}`;    // ========= load =========    const map = loadMap();    const list = (map[pacienteId] || []).slice();    let current = null;    if (itemId) {      current = list.find(e => e.id === itemId) || null;      if (!current) showError("Registro n√£o encontrado.");    }    if (current) {      ensureAnnotations(current);      ensureFields(current);      // normaliza type antigo      if (current.type === "retorno" || current.type === "evolu√ß√£o") current.type = "evolucao";    }    function renderFieldsEditor(ev) {      ensureFields(ev);      const baseFields = fieldsForType(tipoEl.value || "evolucao");      const extra = Array.isArray(ev.extraSections) ? ev.extraSections : [];      const idxEP = baseFields.indexOf("Exame Ps√≠quico");      const beforeEP = idxEP >= 0 ? baseFields.slice(0, idxEP) : baseFields.slice();      const fromEP = idxEP >= 0 ? baseFields.slice(idxEP) : [];      const fields = [...beforeEP, ...extra, ...fromEP];      fieldsWrapEl.innerHTML = "";      fields.forEach((name) => {        const val = ev.fields[name] || "";        const section = document.createElement("div");        section.className = "card";        section.style.marginTop = "10px";        section.style.padding = "12px";        const extraBtn = (name === "Exame Ps√≠quico")          ? `<button type="button" data-fill-ep>+ Exame normal</button>`          : "";        section.innerHTML = `          <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">            <div style="font-weight:600;">${name}</div>            <div style="display:flex; gap:8px; flex-wrap:wrap;">              ${extraBtn}              <button type="button" data-import-field="${name}">Importar anterior</button>            </div>          </div>          <textarea data-field-name="${name}" style="min-height:120px; margin-top:10px;"></textarea>        `;        section.querySelector("textarea").value = val;        fieldsWrapEl.appendChild(section);      });    }    function collectFieldsFromEditor(ev) {      ensureFields(ev);      const areas = fieldsWrapEl.querySelectorAll("textarea[data-field-name]");      areas.forEach((ta) => {        const key = ta.getAttribute("data-field-name");        ev.fields[key] = ta.value.trim();      });    }    function findPreviousWithFields(currentId) {      const sorted = list.slice().sort((a,b) => {        const aa = a.updatedAt || a.registeredAt || "";        const bb = b.updatedAt || b.registeredAt || "";        return bb.localeCompare(aa);      });      for (const ev of sorted) {        if (currentId && ev.id === currentId) continue;        if (ev.mode === "fields" && ev.fields && Object.keys(ev.fields).length) return ev;      }      return null;    }    fieldsWrapEl.addEventListener("click", (e) => {      // ===== Exame Ps√≠quico normal =====      if (e.target?.hasAttribute?.("data-fill-ep")) {        const ta = fieldsWrapEl.querySelector(          'textarea[data-field-name="Exame Ps√≠quico"]'        );        if (!ta) return;        const template =`Apresenta√ß√£o adequada, contato f√°cil, atitude colaborativa, vigil, orientado alo e autopsiquicamente.Aten√ß√£o globalmente preservada. Mem√≥ria e intelig√™ncia n√£o testadas formalmente.Linguagem sem altera√ß√µes. Pensamento de curso e forma preservados, sem conte√∫do prevalente. Consci√™ncia do Eu preservada.Humor eut√≠mico, afeto ressonante, normomodulado. Voli√ß√£o e pragmatismo preservados. Sem sinais de altera√ß√£o da sensopercep√ß√£o, psicomotricidade sem altera√ß√µes.Cr√≠tica e no√ß√£o de doen√ßa presentes.`;        if (ta.value.trim()) {          const ok = confirm(            "Substituir o conte√∫do atual do Exame Ps√≠quico pelo modelo normal?"          );          if (!ok) return;        }        ta.value = template;        return;      }      // ===== Importar campo anterior (o que j√° existia) =====      const fieldName = e.target?.getAttribute?.("data-import-field");      if (!fieldName) return;      const prev = findPreviousWithFields(current?.id);      if (!prev) {        alert("N√£o encontrei registro anterior com campos para importar.");        return;      }      const value =        (prev.fields && prev.fields[fieldName]) ? prev.fields[fieldName] : "";      if (!value) {        alert(`O registro anterior n√£o tem conte√∫do em: ${fieldName}`);        return;      }      const ta = fieldsWrapEl.querySelector(        `textarea[data-field-name="${fieldName}"]`      );      if (ta) ta.value = value;    });    function applyModeUI(ev) {      const m = modoEl.value || "text";      if (ev) ev.mode = m;      if (m === "fields") {        textWrapEl.style.display = "none";        fieldsWrapEl.style.display = "block";        optionalControlsEl.style.display = "block";        renderFieldsEditor(ev);      } else {        fieldsWrapEl.style.display = "none";        textWrapEl.style.display = "block";        optionalControlsEl.style.display = "none";        sectionPickerEl.style.display = "none";      }    }    function renderAnnotations(ev) {      const canShow = !!ev.signedAt && !ev.inactiveAt;      if (!canShow) { annotationsList.style.display = "none"; annotationsItems.innerHTML = ""; return; }      ensureAnnotations(ev);      if (!ev.annotations.length) { annotationsList.style.display = "none"; annotationsItems.innerHTML = ""; return; }      annotationsList.style.display = "block";      annotationsItems.innerHTML = "";      ev.annotations.forEach(a => {        const div = document.createElement("div");        div.className = "card";        div.style.marginTop = "10px";        div.style.padding = "12px";        const when = new Date(a.createdAt).toLocaleString("pt-BR");        div.innerHTML = `          <div class="muted" style="margin-bottom:8px;">${when}</div>          <div style="white-space:pre-wrap;"></div>        `;        div.querySelector("div[style*='white-space']").textContent = a.text;        annotationsItems.appendChild(div);      });    }    function showView(ev) {      editCardEl.style.display = "none";      viewModeEl.style.display = "block";      const regDate = ev.registeredAt ? isoToBRDate(ev.registeredAt) : "";      const consultDate = ev.evolutionDate || regDate;      viewDateEl.textContent = consultDate || "";      viewTypeEl.textContent = "";      if (ev.inactiveAt) {        viewStatusEl.textContent = "INATIVA";        viewStatusEl.style.display = "block";        viewStatusEl.style.color = "#c62828";        viewStatusEl.style.fontWeight = "600";        viewStatusEl.style.textTransform = "uppercase";        viewStatusEl.style.fontSize = "12px";        viewStatusEl.style.marginTop = "10px";      } else {        viewStatusEl.style.display = "none";      }      if (ev.inactiveAt) {        const reason = (ev.inactiveReason || "").trim();        viewInactiveReasonEl.style.display = reason ? "block" : "none";        viewInactiveReasonEl.textContent = reason ? `Motivo: ${reason}` : "";      } else {        viewInactiveReasonEl.style.display = "none";        viewInactiveReasonEl.textContent = "";      }      viewRegisteredEl.textContent =        ev.evolutionDate && regDate && ev.evolutionDate !== regDate          ? `Registrado em: ${regDate}`          : "";      // View do conte√∫do     // limpa    viewFieldsEl.innerHTML = "";    viewFieldsEl.style.display = "none";    viewTextEl.style.display = "none";    if (ev.mode === "fields" && ev.fields) {      const base = fieldsForType(ev.type);      const extra = Array.isArray(ev.extraSections) ? ev.extraSections : [];      const idxEP = base.indexOf("Exame Ps√≠quico");      const beforeEP = idxEP >= 0 ? base.slice(0, idxEP) : base.slice();      const fromEP = idxEP >= 0 ? base.slice(idxEP) : [];      const fields = [...beforeEP, ...extra, ...fromEP];      // render A: headings + texto (sem cards)      viewFieldsEl.style.display = "block";      fields.forEach((k) => {        const v = (ev.fields[k] || "").trim();        if (!v) return;        const h = document.createElement("div");        h.style.fontWeight = "700";        h.style.marginTop = "14px";        h.textContent = k;        const p = document.createElement("div");        p.style.whiteSpace = "pre-wrap";        p.style.marginTop = "6px";        p.textContent = v;        viewFieldsEl.appendChild(h);        viewFieldsEl.appendChild(p);      });      // se n√£o tinha nenhum campo preenchido, mostra aviso simples      if (!viewFieldsEl.childNodes.length) {        viewFieldsEl.style.display = "block";        viewFieldsEl.textContent = "(sem campos preenchidos)";      }    } else {      // texto livre      viewTextEl.style.display = "block";      viewTextEl.textContent = ev.texto || "";    }      // a√ß√µes view      const canEdit = !ev.signedAt;      btnEditarView.style.display = canEdit ? "inline-block" : "none";      btnAssinarView.style.display = canEdit ? "inline-block" : "none";      btnExcluirView.style.display = canEdit ? "inline-block" : "none";      // anotar: s√≥ assinada e ativa      const canAnnotate = !!ev.signedAt && !ev.inactiveAt;      annotationActions.style.display = canAnnotate ? "flex" : "none";      annotationBlock.style.display = "none";      annotationTextEl.value = "";      renderAnnotations(ev);    }    function showEdit(ev) {      ensureFields(ev || current);      viewModeEl.style.display = "none";      editCardEl.style.display = "block";      dataEl.value = ev?.evolutionDate || "";      textoEl.value = ev?.texto || "";      // 1) Tipo sempre define primeiro (vai marcar o segmented)      setTipo(ev?.type || "evolucao");      // 2) Modo:      // - se for registro existente (tem id): usa o modo salvo      // - se for novo (sem id): usa o default por tipo      if (ev?.id) {        setModo(ev?.mode || "text");      } else {        setModo(defaultModeForType(tipoEl.value || "evolucao"));      }      // aplica UI (campos/texto)      applyModeUI(ev || {});    }    // ========= render inicial =========    const now = new Date().toISOString();    if (current) {      // t√≠tulo da p√°gina = tipo (sem ‚ÄúAtendimento‚Äù)      titleEl.textContent = typeLabel(current.type);      // Se assinada ou mode=view -> view      if (isViewMode || current.signedAt) {        showView(current);      } else {        setTipo(current.type || "evolucao");        showEdit(current);      }      } else {        current = { id: null, type:"evolucao", mode:"text", fields:{}, extraSections:[], annotations:[] };        ensureAnnotations(current);        ensureFields(current);        setTipo("evolucao");        showEdit(current);      }    // Picker de Se√ß√µes Opcionais    function refreshSectionOptions() {      if (!current) return;      ensureFields(current);      const base = fieldsForType(tipoEl.value || "evolucao");      const chosen = new Set([...(current.extraSections || []), ...base]);      sectionOptionsEl.innerHTML = "";      const available = OPTIONAL_SECTIONS.filter(s => !chosen.has(s));      if (!available.length) {        const div = document.createElement("div");        div.className = "muted";        div.style.padding = "12px";        div.textContent = "Nenhuma se√ß√£o opcional dispon√≠vel.";        sectionOptionsEl.appendChild(div);        return;      }      available.forEach((name) => {        const btn = document.createElement("button");        btn.type = "button";        btn.className = "picker-item";        btn.textContent = name;        btn.addEventListener("click", () => {          current.extraSections.push(name);          sectionPickerEl.style.display = "none";          renderFieldsEditor(current);          refreshSectionOptions();        });        sectionOptionsEl.appendChild(btn);      });    }    addSectionBtn.addEventListener("click", () => {      if (!current) return;      if (sectionPickerEl.style.display === "block") {        sectionPickerEl.style.display = "none";        return;      }      sectionPickerEl.style.display = "block";      refreshSectionOptions();    });    // ========= a√ß√µes view =========    btnEditarView.addEventListener("click", () => {      if (!current) return;      window.location.href =        `/evolucao-form.html?pacienteId=${encodeURIComponent(pacienteId)}&id=${encodeURIComponent(current.id)}`;    });    btnAssinarView.addEventListener("click", () => {      if (!current) return;      // s√≥ assina se j√° existe id (rascunho salvo)      if (!confirm("Ao assinar, o registro n√£o poder√° mais ser editado.\n\nDeseja continuar?")) return;      current.signedAt = new Date().toISOString();      current.updatedAt = current.signedAt;      if (!current.registeredAt) current.registeredAt = current.signedAt;      const idx = list.findIndex(e => e.id === current.id);      if (idx >= 0) list[idx] = current;      map[pacienteId] = list;      saveMap(map);      window.location.href =        `/evolucao-form.html?pacienteId=${encodeURIComponent(pacienteId)}&id=${encodeURIComponent(current.id)}&mode=view`;    });    btnExcluirView.addEventListener("click", () => {      if (!current) return;      if (current.signedAt) {        alert("Registros assinados n√£o podem ser exclu√≠dos. Use inativar na timeline.");        return;      }      const ok = confirm("Excluir este rascunho? Esta a√ß√£o n√£o pode ser desfeita.");      if (!ok) return;      map[pacienteId] = (map[pacienteId] || []).filter(e => e.id !== current.id);      saveMap(map);      window.location.href = `/paciente.html?id=${encodeURIComponent(pacienteId)}`;    });    // ========= salvar =========    saveBtn.addEventListener("click", () => {      const modeSelected = modoEl.value || "text";      const typeSelected = tipoEl.value || "evolucao";      const evolutionDate = dataEl.value.trim() || null;      const now2 = new Date().toISOString();      let idToOpen = null;      if (current) {        if (current.signedAt) {          alert("Registro assinado n√£o pode ser editado.");          return;        }        current.type = typeSelected;        current.mode = modeSelected;        current.evolutionDate = evolutionDate;        current.updatedAt = now2;        if (modeSelected === "fields") {          ensureFields(current);          collectFieldsFromEditor(current);        } else {          const t = textoEl.value.trim();          if (!t) { alert("Informe o texto do registro."); return; }          current.texto = t;        }        idToOpen = current.id;      } else {        const newId = crypto.randomUUID();        const newEv = {          id: newId,          pacienteId,          type: typeSelected,          mode: modeSelected,          evolutionDate,          registeredAt: now2,          updatedAt: now2,          signedAt: null,          inactiveAt: null,          inactiveReason: null,          annotations: [],          fields: {}        };        if (modeSelected === "fields") {          collectFieldsFromEditor(newEv);        } else {          const t = textoEl.value.trim();          if (!t) { alert("Informe o texto do registro."); return; }          newEv.texto = t;        }        list.push(newEv);        map[pacienteId] = list;        saveMap(map);        current = newEv; // vira current na mem√≥ria        idToOpen = newId;      }      // salva no storage        const idx = list.findIndex(e => e.id === current.id);        if (idx < 0) {          showError("Registro n√£o encontrado.");          return;        }        list[idx] = current;        map[pacienteId] = list;        saveMap(map);      // ‚úÖ ap√≥s salvar ‚Üí ir para VIEW e mostrar bot√µes (editar/assinar/excluir)      window.location.href =        `/evolucao-form.html?pacienteId=${encodeURIComponent(pacienteId)}&id=${encodeURIComponent(idToOpen)}&mode=view`;    });    // ========= assinar (edit mode) =========    signBtn.addEventListener("click", () => {      if (!current) { alert("Salve antes de assinar."); return; }      if (!confirm("Ao assinar, o registro n√£o poder√° mais ser editado.\n\nDeseja continuar?")) return;      current.signedAt = new Date().toISOString();      current.updatedAt = current.signedAt;      if (!current.registeredAt) current.registeredAt = current.signedAt;      const idx = list.findIndex(e => e.id === current.id);      if (idx >= 0) list[idx] = current;      map[pacienteId] = list;      saveMap(map);      window.location.href =        `/evolucao-form.html?pacienteId=${encodeURIComponent(pacienteId)}&id=${encodeURIComponent(current.id)}&mode=view`;    });    // ========= excluir (edit mode) =========    deleteBtn.addEventListener("click", () => {      if (!current) return;      if (current.signedAt) {        alert("Registros assinados n√£o podem ser exclu√≠dos. Use inativar na timeline.");        return;      }      const ok = confirm("Excluir este rascunho? Esta a√ß√£o n√£o pode ser desfeita.");      if (!ok) return;      map[pacienteId] = (map[pacienteId] || []).filter(e => e.id !== current.id);      saveMap(map);      window.location.href = `/paciente.html?id=${encodeURIComponent(pacienteId)}`;    });    // ========= anotar =========    addAnnotationBtn.addEventListener("click", () => {      annotationBlock.style.display = "block";      annotationTextEl.focus();    });    saveAnnotationBtn.addEventListener("click", () => {      if (!current) return;      if (!current.signedAt || current.inactiveAt) {        alert("N√£o √© poss√≠vel anotar neste registro.");        return;      }      const text = annotationTextEl.value.trim();      if (!text) { alert("Digite a anota√ß√£o."); return; }      ensureAnnotations(current);      current.annotations.push({ id: crypto.randomUUID(), text, createdAt: new Date().toISOString() });      const idx = list.findIndex(e => e.id === current.id);      if (idx >= 0) list[idx] = current;      map[pacienteId] = list;      saveMap(map);      renderAnnotations(current);      annotationTextEl.value = "";      annotationBlock.style.display = "none";      alert("Anota√ß√£o adicionada.");    });  </script></body></html>